{"version":3,"sources":["mvc/components/GlobalErrorHandlerMiddleware.ts"],"names":[],"mappings":"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","file":"GlobalErrorHandlerMiddleware.js","sourcesContent":["import * as Express from \"express\";\nimport {Exception} from \"ts-httpexceptions\";\nimport {ServerSettingsService} from \"../../config\";\nimport {Err} from \"../../filters/decorators/error\";\nimport {Request} from \"../../filters/decorators/request\";\nimport {Response} from \"../../filters/decorators/response\";\nimport {MiddlewareError} from \"../decorators/class/middlewareError\";\nimport {IMiddlewareError} from \"../interfaces\";\nimport {IResponseError} from \"../interfaces/IResponseError\";\n\n/**\n * @middleware\n */\n@MiddlewareError()\nexport class GlobalErrorHandlerMiddleware implements IMiddlewareError {\n  private headerName: string;\n\n  constructor(settingsServerService: ServerSettingsService) {\n    const {headerName = \"errors\"} = settingsServerService.errors;\n    this.headerName = headerName;\n  }\n\n  use(@Err() error: any, @Request() request: Express.Request, @Response() response: Express.Response): any {\n    const toHTML = (message = \"\") => message.replace(/\\n/gi, \"<br />\");\n\n    if (error instanceof Exception || error.status) {\n      request.log.error({\n        error: {\n          message: error.message,\n          stack: error.stack,\n          status: error.status,\n          origin: error.origin\n        }\n      });\n\n      this.setHeaders(response, error, error.origin);\n\n      response.status(error.status).send(toHTML(error.message));\n\n      return;\n    }\n\n    if (typeof error === \"string\") {\n      response.status(404).send(toHTML(error));\n\n      return;\n    }\n\n    request.log.error({\n      error: {\n        status: 500,\n        message: error.message,\n        stack: error.stack,\n        origin: error.origin\n      }\n    });\n\n    this.setHeaders(response, error, error.origin);\n\n    response.status(error.status || 500).send(\"Internal Error\");\n\n    return;\n  }\n\n  /**\n   *\n   * @param {e.Response} response\n   * @param args\n   */\n  setHeaders(response: Express.Response, ...args: IResponseError[]) {\n    let hErrors: any = [];\n\n    args.filter(o => !!o).forEach(({headers, errors}: IResponseError) => {\n      if (headers) {\n        response.set(headers);\n      }\n\n      if (errors) {\n        hErrors = hErrors.concat(errors);\n      }\n    });\n\n    if (hErrors.length) {\n      response.set(this.headerName, JSON.stringify(hErrors));\n    }\n  }\n}\n"],"sourceRoot":"../../../src"}